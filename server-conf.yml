# Synapse Homeserver Configuration File

# -----------------------------------------------------------------------------
# General Configuration
# -----------------------------------------------------------------------------
server_name: "matrix-srv.xaas.ir"  # Your server's domain name

pid_file: /data/homeserver.pid      # Path to store the PID file

# -----------------------------------------------------------------------------
# Listeners Configuration
# -----------------------------------------------------------------------------
listeners:
  - port: 8448                      # Port for federation (HTTPS)
    tls: true                       # Enable TLS for secure communication
    type: http
    x_forwarded: true               # Trust X-Forwarded-For headers (if behind a proxy)
    bind_addresses:
      - "0.0.0.0"                   # Listen on all network interfaces
    resources:
      - names: [client, federation]
        compress: true              # Enable compression for efficiency
        verify_client_cert: false   # Set to true if requiring client certificates
        tls_certificate_path: "/data/certs/fullchain.pem"  # Path to TLS certificate
        tls_private_key_path: "/data/certs/privkey.pem"    # Path to TLS private key

  - port: 8008                      # Port for client-server API (HTTP)
    tls: false                      # Disable TLS (recommend proxying with TLS)
    type: http
    bind_addresses:
      - "127.0.0.1"                 # Bind to localhost for security
    resources:
      - names: [client]
        compress: false

# -----------------------------------------------------------------------------
# Database Configuration
# -----------------------------------------------------------------------------
database:
  name: psycopg2                     # Use PostgreSQL for better performance
  args:
    user: synapse_user               # PostgreSQL username
    password: "StrongP@ssw0rd!"      # PostgreSQL password (use a strong password)
    host: localhost                   # Database host
    database: synapse                # Database name
    cp_min: 5                         # Minimum number of connections
    cp_max: 10                        # Maximum number of connections

# -----------------------------------------------------------------------------
# Logging Configuration
# -----------------------------------------------------------------------------
log_config: "/data/matrix-srv.xaas.ir.log.config"  # Path to log configuration file

# -----------------------------------------------------------------------------
# Media Store Configuration
# -----------------------------------------------------------------------------
media_store_path: /data/media_store    # Directory to store media files

# -----------------------------------------------------------------------------
# Secrets and Keys Configuration
# -----------------------------------------------------------------------------
registration_shared_secret: "XMiHr*TH@A1J9TdGG0x.0xhGq^K4f2i@StCNaqq~&.4JF&4b&c"  # Shared secret for registration

macaroon_secret_key: "6@D*N=EstJEjZezoaE~S~rvZ#cN-QdUch3Otaus0AzNkrL,W~c"         # Secret key for macaroons

form_secret: "TSfEve1._8g.V:_eh&=F;7a-QgWgWwmWKJLdgKPalJmzhObONU"                  # Secret key for forms

signing_key_path: "/data/matrix-srv.xaas.ir.signing.key"                        # Path to signing key

# -----------------------------------------------------------------------------
# Trusted Key Servers for Federation
# -----------------------------------------------------------------------------
trusted_key_servers:
  - server_name: "matrix.org"       # Trusted external server for federation

# -----------------------------------------------------------------------------
# Registration Settings
# -----------------------------------------------------------------------------
enable_registration: true                        # Allow user registrations
enable_registration_without_verification: true   # Allow registrations without email/SMS verification

# -----------------------------------------------------------------------------
# Auto-Join Rooms Configuration
# -----------------------------------------------------------------------------
auto_join_rooms:
  - "#public:matrix-srv.xaas.ir"                # Rooms that new users automatically join

# -----------------------------------------------------------------------------
# Rate Limiting Configuration
# -----------------------------------------------------------------------------
rc_messages:
  max_messages_per_second: 100                    # Maximum messages per second per user

rc_registration:
  per_second: 5                                   # Registration attempts per second
  burst_count: 10                                 # Burst attempts allowed

# -----------------------------------------------------------------------------
# CORS Configuration
# -----------------------------------------------------------------------------
cors_origins:
  - "*"                                           # Allowed origins for cross-origin requests
                                                 # Replace "*" with specific domains for enhanced security

# -----------------------------------------------------------------------------
# Application Services Configuration
# -----------------------------------------------------------------------------
app_service_config_files:
  - "/data/appservices.yaml"                      # Path to application services configuration

# -----------------------------------------------------------------------------
# Federation Settings
# -----------------------------------------------------------------------------
federation_domain_whitelist:
  - "matrix.org"                                   # Domains allowed for federation

# -----------------------------------------------------------------------------
# Worker Configuration (Optional for Scaling)
# -----------------------------------------------------------------------------
# Uncomment and configure the following if using workers
# worker_app:
#   - "synapse.app.federation_sender"
#   - "synapse.app.federation_server"

# -----------------------------------------------------------------------------
# Additional Security Settings
# -----------------------------------------------------------------------------
# Enable Content Security Policy (CSP) headers
content_security_policy:
  default_src:
    - "'self'"
  script_src:
    - "'self'"
    - "'unsafe-inline'"
  style_src:
    - "'self'"
    - "'unsafe-inline'"

# -----------------------------------------------------------------------------
# Metrics and Monitoring
# -----------------------------------------------------------------------------
# Enable Prometheus metrics (requires additional setup)
# metrics:
#   enabled: true
#   bind_address: "0.0.0.0"
#   port: 9000

# -----------------------------------------------------------------------------
# Encryption and Key Backup (Optional)
# -----------------------------------------------------------------------------
# encryption:
#   # Enable end-to-end encryption features
#   enabled: true

# -----------------------------------------------------------------------------
# Event Retention and Purging (Optional)
# -----------------------------------------------------------------------------
# event_purger:
#   enabled: true
#   room_retention_days: 365                     # Retain room events for 1 year

# -----------------------------------------------------------------------------
# File Permissions and Security
# -----------------------------------------------------------------------------
# Ensure that all secret files and directories are readable only by the Synapse user
# Example commands:
# chmod 600 /data/matrix-srv.xaas.ir.signing.key
# chmod 600 /data/certs/privkey.pem
# chown -R synapse:synapse /data/

# -----------------------------------------------------------------------------
# Final Notes
# -----------------------------------------------------------------------------
# - Replace placeholder values (e.g., passwords, secrets) with secure, unique values.
# - Obtain and place your TLS certificates in the specified paths.
# - Regularly back up your configuration files and databases.
# - Test the configuration in a staging environment before deploying to production.
# - Monitor logs and metrics to ensure the server operates smoothly.

# vim:ft=yaml
